<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AICC 고객 채팅</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container { max-width: 800px; margin: 30px auto; }
        .chat-box { height: 600px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: #f0f2f5; display: flex; flex-direction: column; }
        .message { margin-bottom: 10px; max-width: 80%; display: flex; flex-direction: column; }
        .message.my { align-self: flex-end; align-items: flex-end; }
        .message.other { align-self: flex-start; align-items: flex-start; }
        .message .content { padding: 8px 12px; border-radius: 15px; font-size: 14px; position: relative; white-space: pre-wrap; word-break: break-all; }
        .message.my .content { background: #0d6efd; color: white; border-bottom-right-radius: 2px; }
        .message.other .content { background: white; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .system { text-align: center; color: #888; font-size: 0.8em; margin: 10px 0; width: 100%; }
        textarea#message { resize: none; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container chat-container">
    <h3 class="text-center mb-4">고객 상담 채팅</h3>
    
    <!-- 로그인 폼 -->
    <div id="login-form">
        <h4 class="mb-3">로그인</h4>
        <div class="mb-3">
            <label class="form-label">아이디</label>
            <input type="text" id="loginId" class="form-control" value="hong">
        </div>
        <div class="mb-3">
            <label class="form-label">비밀번호</label>
            <input type="password" id="loginPw" class="form-control" value="1234">
        </div>
        <button class="btn btn-success w-100" onclick="login()">로그인</button>
    </div>

    <!-- 접속 폼 -->
    <div id="connect-form" style="display:none;">
        <div class="mb-3">
            <label class="form-label">사용자 정보</label>
            <input type="text" id="nickname" class="form-control" readonly>
        </div>
        <div class="mb-3">
            <label class="form-label">상담 문의 (방 이름)</label>
            <input type="text" id="roomName" class="form-control" placeholder="배송 문의합니다.">
        </div>
        <button class="btn btn-primary w-100" onclick="createRoom()">상담 시작하기</button>
    </div>

    <!-- 채팅 화면 -->
    <div id="chat-page" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span id="room-title" class="fw-bold"></span>
            <div>
                <button class="btn btn-sm btn-warning me-1" id="handoffBtn" onclick="requestHandoff()">상담원 연결</button>
                <button class="btn btn-sm btn-outline-secondary me-1" id="cancelHandoffBtn" onclick="cancelHandoff()" style="display:none;">연결 취소</button>
                <button class="btn btn-sm btn-outline-danger" onclick="disconnect()">종료</button>
            </div>
        </div>
        <div id="chat-box" class="chat-box mb-3"></div>
        <div class="input-group">
            <textarea id="message" class="form-control" placeholder="메시지를 입력하세요..." rows="1" onkeydown="handleKey(event)"></textarea>
            <button class="btn btn-primary" onclick="sendMessage()">전송</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentRoomId = null;
    let nickname = null;
    let authToken = null;

    // 초기 로딩 시 로그인 상태 확인
    window.onload = function() {

        const token = sessionStorage.getItem("AUTH_TOKEN");
        console.log('ㅁ token>>> [' + token + ']');
        if (token) {
            fetch('/api/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => {
                if (res.ok) {
                    const json = res.json();
                    return json; //res.json();
                }
                sessionStorage.removeItem("AUTH_TOKEN");
                throw new Error('Invalid token');
            })
            .then(user => {
                onLoginSuccess(user);
            })
            .catch(() => {
                document.getElementById("login-form").style.display = "block";
            });
        } else {
            document.getElementById("login-form").style.display = "block";
        }
    }

    function login() {
        const id = document.getElementById("loginId").value;
        const pw = document.getElementById("loginPw").value;

        fetch(`/api/customer/apt001/login?id=${id}&password=${pw}`, { method: 'POST' })
            .then(res => res.json())
            .then(user => {
                sessionStorage.setItem("AUTH_TOKEN", user.token);
                onLoginSuccess(user);
            })
            .catch(err => {
                alert("로그인에 실패했습니다.");
            });
    }

    function onLoginSuccess(user) {
        nickname = user.userName;
        authToken = user.token;
// 연결 전 토큰 저장
localStorage.setItem('authToken', authToken);
localStorage.setItem('user.userName', user.userName);
localStorage.setItem('user.userId', user.userId);

        console.log('ㅁ onLoginSuccess> nickname >[' + nickname + ']');
        console.log('ㅁ onLoginSuccess> authToken >[' + authToken + ']');
        document.getElementById("nickname").value = `${user.userName} (${user.userId})`;
        document.getElementById("login-form").style.display = "none";
        document.getElementById("connect-form").style.display = "block";
    }

    function createRoom() {
        const roomName = document.getElementById("roomName").value;

        if (!roomName) {
            alert("상담 문의 내용을 입력해주세요.");
            return;
        }

        // 1. 방 생성 및 봇 초기화 API 호출
        fetch(`/api/customer/chatbot`, { 
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
            .then(res => {
                if (res.status === 401) {
                    alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                    sessionStorage.removeItem("AUTH_TOKEN");
                    window.location.reload();
                    return;
                }
                return res.json();
            })
            .then(room => {
                if (!room) return;
                console.log("Room initialized:", room);
                currentRoomId = room.roomId; // 서버에서 새로 생성된 roomId 저장
                
                updateHandoffButtons(room.status);
                connect();
            })
            .catch(err => {
                console.error(err);
                alert("상담 연결에 실패했습니다.");
            });
    }

    function updateHandoffButtons(status) {
        const handoffBtn = document.getElementById("handoffBtn");
        const cancelBtn = document.getElementById("cancelHandoffBtn");

        if (status === 'WAITING') {
            handoffBtn.disabled = true;
            handoffBtn.innerText = "상담원 연결 중";
            cancelBtn.style.display = "inline-block";
        } else if (status === 'AGENT') {
            handoffBtn.disabled = true;
            handoffBtn.innerText = "상담원 연결됨";
            cancelBtn.style.display = "none";
        } else if (status === 'CLOSED') {
            handoffBtn.disabled = true;
            handoffBtn.innerText = "상담 종료됨";
            cancelBtn.style.display = "none";
        } else {
            // BOT or other
            handoffBtn.disabled = false;
            handoffBtn.innerText = "상담원 연결";
            cancelBtn.style.display = "none";
        }
    }

    function connect() {
        // 토큰과 roomId를 쿼리 파라미터로 전달
        console.log('connect > authToken[' + authToken + '], currentRoomId[' + currentRoomId +']');
        const socket = new SockJS(`/ws-chat?token=${authToken}&roomId=${currentRoomId}`);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            
            // UI 전환
            document.getElementById("connect-form").style.display = "none";
            document.getElementById("chat-page").style.display = "block";
            document.getElementById("room-title").innerText = document.getElementById("roomName").value || "상담 중";

            // 2. 구독 (Subscribe) - 서버에서 받은 고유 roomId 사용
            stompClient.subscribe('/topic/room/' + currentRoomId, function (message) {
                const payload = typeof message.body === 'string' ? JSON.parse(message.body) : message.body;
                showMessage(payload);
            });

            // 3. 입장 메시지 전송
            stompClient.send("/app/customer/chat", {}, JSON.stringify({
                roomId: currentRoomId,
                sender: nickname,
                type: 'JOIN',
                message: nickname + "님이 입장하셨습니다."
            }));
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.send("/app/customer/chat", {}, JSON.stringify({
                roomId: currentRoomId,
                sender: nickname,
                type: 'LEAVE',
                message: nickname + "님이 나갔습니다."
            }));
            stompClient.disconnect();
            stompClient = null;
        }
        
        // 2. 상담 종료 시 토큰은 유지하고 방 정보만 초기화하여 상담 신청 화면으로 이동
        currentRoomId = null;
        document.getElementById("chat-box").innerHTML = "";
        document.getElementById("chat-page").style.display = "none";
        document.getElementById("connect-form").style.display = "block";
        document.getElementById("roomName").value = "";
    }

    function requestHandoff() {
        if (stompClient && currentRoomId) {
            const chatMessage = {
                roomId: currentRoomId,
                sender: nickname,
                message: "상담원 연결을 요청합니다.",
                type: 'HANDOFF'
            };
            stompClient.send("/app/customer/chat", {}, JSON.stringify(chatMessage));
            updateHandoffButtons('WAITING');
        }
    }

    function cancelHandoff() {
        if (stompClient && currentRoomId) {
            const chatMessage = {
                roomId: currentRoomId,
                sender: nickname,
                message: "상담원 연결 요청을 취소합니다.",
                type: 'CANCEL_HANDOFF'
            };
            stompClient.send("/app/customer/chat", {}, JSON.stringify(chatMessage));
            updateHandoffButtons('BOT');
        }
    }

    function sendMessage() {
        const messageInput = document.getElementById("message");
        const messageContent = messageInput.value.trim();
        
        if(messageContent && stompClient && currentRoomId) {
            const chatMessage = {
                roomId: currentRoomId,
                sender: nickname,
                message: messageContent,
                type: 'TALK'
            };
            stompClient.send("/app/customer/chat", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
            messageInput.style.height = 'auto'; // 높이 초기화
        }
    }

    function handleKey(event) {
        const input = event.target;
        if (event.keyCode === 13) {
            if (!event.shiftKey) {
                event.preventDefault(); // 기본 Enter 줄바꿈 방지
                sendMessage();
            }
            // Shift + Enter는 기본 동작(줄바꿈) 허용
        }
        
        // 높이 자동 조절
        setTimeout(() => {
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        }, 0);
    }

    function showMessage(message) {
        const chatBox = document.getElementById("chat-box");
        const div = document.createElement("div");

        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            div.className = "system";
            div.innerText = message.message;
            
            // 상담 종료(LEAVE) 시 버튼 상태 초기화
            if (message.type === 'LEAVE') {
                updateHandoffButtons('CLOSED');
            }
        } else {
            const isMe = message.senderRole === 'CUSTOMER';
            div.className = isMe ? "message my" : "message other";
            div.innerHTML = `<div class="fw-bold" style="font-size:12px; margin-bottom:2px;">${message.sender}</div>
                             <div class="content">${message.message}</div>`;
            
            // 시스템 메시지로 상담원 연결 확인
            if (message.sender === 'System' && message.message.includes("상담원과 연결되었습니다.")) {
                updateHandoffButtons('AGENT');
            }
            // 상담원 연결 취소 확인
            if (message.sender === 'System' && message.message.includes("상담원 연결 요청을 취소하였습니다.")) {
                updateHandoffButtons('BOT');
            }
        }
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>