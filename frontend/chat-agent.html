<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CHAT ìƒë‹´ì‚¬ ì½˜ì†”</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html { height: 100vh; overflow: hidden; }
        .sidebar { height: 100%; border-right: 1px solid #ddd; padding: 20px; background: #f8f9fa; overflow-y: auto; }
        .chat-area { height: 100%; display: flex; flex-direction: column; }
        .chat-tabs { border-bottom: 1px solid #ddd; background: #fff; padding: 10px 10px 0 10px; display: flex; overflow-x: auto; }
        .chat-tab { position: relative; padding: 10px 40px 10px 15px; border: 1px solid #ddd; border-bottom: none; background: #f8f9fa; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; white-space: nowrap; transition: 0.2s; }
        .chat-tab:hover { background: #e9ecef; }
        .chat-tab.active { background: #fff; font-weight: bold; border-bottom: 2px solid #fff; margin-bottom: -1px; }
        .chat-tab .close-tab { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px; cursor: pointer; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        .chat-tab .close-tab:hover { color: #dc3545; }
        .chat-header { padding: 15px; border-bottom: 1px solid #ddd; background: #fff; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; }
        .chat-input { padding: 20px; border-top: 1px solid #ddd; background: #fff; }
        
        .room-item { cursor: pointer; padding: 10px; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; }
        .room-item:hover { background: #e9ecef; }
        .room-item.active { background: #0d6efd; color: white; }
        .room-item.waiting { border: 2px solid #ffc107; background: #fff3cd; animation: blink-waiting 1.5s infinite; }
        .room-item.needs-reply { border-left: 5px solid #dc3545; background: #f8d7da; animation: blink-reply 1s infinite; }
        
        @keyframes blink-waiting {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeeba; }
            100% { background-color: #fff3cd; }
        }

        @keyframes blink-reply {
            0% { background-color: #f8d7da; }
            50% { background-color: #f5c2c7; }
            100% { background-color: #f8d7da; }
        }
        
        .message { margin-bottom: 10px; max-width: 75%; display: flex; flex-direction: column; }
        .message.my { align-self: flex-end; align-items: flex-end; }
        .message.other { align-self: flex-start; align-items: flex-start; }
        .message .bubble { padding: 8px 15px; border-radius: 15px; font-size: 14px; white-space: pre-wrap; word-break: break-all; }
        .message.my .bubble { background: #0d6efd; color: white; border-bottom-right-radius: 2px; }
        .message.other .bubble { background: white; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .message .timestamp { font-size: 10px; color: #999; margin-top: 2px; }
        .message.my .timestamp { text-align: right; }
        .message.other .timestamp { text-align: left; }
        .system-msg { text-align: center; font-size: 12px; color: #888; margin: 10px 0; width: 100%; }
        textarea#message { resize: none; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body>

<div id="login-form" class="container mt-5" style="max-width: 400px;">
    <h3 class="text-center mb-4">ìƒë‹´ì› ë¡œê·¸ì¸</h3>
    <div class="mb-3">
        <label class="form-label">ì•„ì´ë””</label>
        <input type="text" id="loginId" class="form-control" value="agent01">
    </div>
    <div class="mb-3">
        <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="loginPw" class="form-control" value="1234">
    </div>
    <button class="btn btn-primary w-100" onclick="login()">ë¡œê·¸ì¸</button>
</div>

<div id="admin-main" class="row g-0 h-100" style="display: none;">
    <!-- ì™¼ìª½: ë°© ëª©ë¡ -->
    <div class="col-md-3 sidebar">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">ìƒë‹´ ëª©ë¡</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div class="mb-3">
            <small class="text-muted">ì ‘ì† ìƒë‹´ì›:</small>
            <strong id="displayAgentName"></strong>
        </div>
        <div id="room-list">
            <!-- Room List Items -->
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì±„íŒ… ì˜ì—­ -->
    <div class="col-md-9 chat-area">
        <!-- íƒ­ ì˜ì—­ -->
        <div class="chat-tabs" id="chat-tabs">
            <!-- Tabs will be dynamically added here -->
        </div>
        
        <!-- í™œì„± ì±„íŒ… ì˜ì—­ -->
        <div class="chat-header" id="chat-header">
            <span class="fw-bold fs-5">ìƒë‹´ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
        </div>
        <div class="chat-box" id="chat-box">
            <!-- Messages -->
        </div>
        <div class="chat-input">
            <div class="input-group">
                <textarea id="message" class="form-control" placeholder="ë©”ì‹œì§€ ì…ë ¥..." rows="1" disabled onkeydown="handleKey(event)"></textarea>
                <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentRoomId = null;
    let nickname = null;
    let authToken = null;
    let currentUserId = null; // ìƒë‹´ì› ID ì €ì¥
    let roomMessages = {}; // roomId -> Array of messages
    let subscriptions = {}; // roomId -> subscription object
    let unreadRooms = {}; // roomId -> boolean (true if needs reply)
    let roomsData = []; // ì „ì—­ ë°© ë°ì´í„° ë³´ê´€
    let openTabs = {}; // roomId -> room object (ì—´ë ¤ìˆëŠ” íƒ­ ê´€ë¦¬)
    let tabOrder = []; // roomId ë°°ì—´ (íƒ­ ìˆœì„œ ê´€ë¦¬)
    let heartbeatInterval = null; // í•˜íŠ¸ë¹„íŠ¸ ì¸í„°ë²Œ

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    window.onload = function() {
        const token = sessionStorage.getItem("AGENT_TOKEN");
        if (token) {
            checkAuth(token);
        } else {
            document.getElementById("login-form").style.display = "block";
        }
    }

    function login() {
        const id = document.getElementById("loginId").value;
        const pw = document.getElementById("loginPw").value;

        // ìƒë‹´ì› ì „ìš© ë¡œê·¸ì¸ API í˜¸ì¶œ
        fetch(`/api/agent/login?id=${id}&password=${pw}`, { method: 'POST' })
            .then(res => res.json())
            .then(user => {
                sessionStorage.setItem("AGENT_TOKEN", user.token);
                sessionStorage.setItem("AGENT_NAME", user.userName);
                checkAuth(user.token);
            })
            .catch(err => alert("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    }

    function checkAuth(token) {
        fetch('/api/agent/me', {
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => {
            if (res.ok) return res.json();
            throw new Error();
        })
        .then(user => {
            authToken = token;
            nickname = user.userName;
            currentUserId = user.userId; // ìƒë‹´ì› ID ì €ì¥
            document.getElementById("displayAgentName").innerText = `${nickname} (${currentUserId})`;
            document.getElementById("login-form").style.display = "none";
            document.getElementById("admin-main").style.display = "flex";
            connectWebSocket();
        })
        .catch(() => {
            sessionStorage.removeItem("AGENT_TOKEN");
            document.getElementById("login-form").style.display = "block";
            document.getElementById("admin-main").style.display = "none";
        });
    }

    function logout() {
        // í•˜íŠ¸ë¹„íŠ¸ ì¤‘ë‹¨
        stopHeartbeat();
        
        sessionStorage.removeItem("AGENT_TOKEN");
        window.location.reload();
    }

    function connectWebSocket() {
        // í† í°ì„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
        const socket = new SockJS('/ws-chat?token=' + authToken); // /ws-chat/info?token= ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìë™ í˜¸ì¶œ
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, function () {
            console.log("WebSocket Connected for Admin");
            
            // 1. ë°© ëª©ë¡ ì‹¤ì‹œê°„ í‘¸ì‹œ êµ¬ë…
            stompClient.subscribe('/topic/rooms', function (message) {
                const rooms = JSON.parse(message.body);
                updateRoomListUI(rooms);
            });

            // ì´ˆê¸° ëª©ë¡ ë¡œë“œ
            loadRooms();
            
            // í•˜íŠ¸ë¹„íŠ¸ ì‹œì‘ (5ë¶„ë§ˆë‹¤ ì˜¨ë¼ì¸ ìƒíƒœ ê°±ì‹ )
            startHeartbeat();
        });
    }

    /**
     * í•˜íŠ¸ë¹„íŠ¸ ì‹œì‘ - ì˜¨ë¼ì¸ ìƒíƒœ ìœ ì§€
     */
    function startHeartbeat() {
        // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
        sendHeartbeat();
        
        // 5ë¶„ë§ˆë‹¤ í•˜íŠ¸ë¹„íŠ¸ ì „ì†¡
        heartbeatInterval = setInterval(() => {
            sendHeartbeat();
        }, 5 * 60 * 1000); // 5ë¶„
        
        console.log('ìƒë‹´ì› í•˜íŠ¸ë¹„íŠ¸ ì‹œì‘ (5ë¶„ ê°„ê²©)');
    }

    /**
     * í•˜íŠ¸ë¹„íŠ¸ ì „ì†¡
     */
    function sendHeartbeat() {
        fetch('/api/agent/me', {
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(res => {
            if (res.ok) {
                console.log('í•˜íŠ¸ë¹„íŠ¸ ì „ì†¡ ì„±ê³µ');
            } else {
                console.warn('í•˜íŠ¸ë¹„íŠ¸ ì „ì†¡ ì‹¤íŒ¨ - ì¬ë¡œê·¸ì¸ í•„ìš”');
            }
        })
        .catch(err => {
            console.error('í•˜íŠ¸ë¹„íŠ¸ ì˜¤ë¥˜:', err);
        });
    }

    /**
     * í•˜íŠ¸ë¹„íŠ¸ ì¤‘ë‹¨
     */
    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
            console.log('ìƒë‹´ì› í•˜íŠ¸ë¹„íŠ¸ ì¤‘ë‹¨');
        }
    }

    function loadRooms() {
        fetch('/api/agent/rooms')
            .then(res => res.json())
            .then(rooms => updateRoomListUI(rooms));
    }

    function updateRoomListUI(rooms) {
        roomsData = rooms;
        const list = document.getElementById("room-list");
        list.innerHTML = "";
        
        if(rooms.length === 0) {
            list.innerHTML = "<div class='text-center text-muted'>ëŒ€ê¸° ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
        }

        rooms.forEach(room => {
            // ë°±ê·¸ë¼ìš´ë“œ êµ¬ë… ê´€ë¦¬: ì—´ë¦° íƒ­ì´ ì•„ë‹Œ ë°©ì€ êµ¬ë… í•´ì œ
            if (openTabs[room.roomId]) {
                // ì—´ë¦° íƒ­ì€ í•­ìƒ êµ¬ë… ìœ ì§€
                if (!subscriptions[room.roomId]) {
                    subscribeToRoom(room.roomId);
                }
            } else {
                // ì—´ë¦° íƒ­ì´ ì•„ë‹ˆë©´ êµ¬ë… í•´ì œ
                if (subscriptions[room.roomId]) {
                    subscriptions[room.roomId].unsubscribe();
                    delete subscriptions[room.roomId];
                }
            }

            const div = document.createElement("div");
            const isBot = room.status === 'BOT';
            const isWaiting = room.status === 'WAITING';
            const isMyRoom = room.status === 'AGENT' && room.assignedAgent === nickname;
            const hasUnread = unreadRooms[room.roomId];
            const isOpen = openTabs[room.roomId] ? true : false;
            
            div.className = `room-item ${isOpen ? 'active' : ''} ${isWaiting ? 'waiting' : ''} ${hasUnread && !isOpen ? 'needs-reply' : ''}`;
            
            const displayName = room.roomName || 'ì•Œ ìˆ˜ ì—†ëŠ” ê³ ê°';
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${displayName}</strong>
                    <div>
                        ${isOpen ? '<span class="badge bg-success">ì—´ë¦¼</span>' : ''}
                        ${isBot ? '<span class="badge bg-info">ì±—ë´‡ìƒë‹´ì¤‘</span>' : ''}
                        ${room.status === 'CLOSED' ? '<span class="badge bg-danger">ìƒë‹´ì¢…ë£Œ</span>' : ''}
                        ${isMyRoom ? '<span class="badge bg-primary">ìƒë‹´ì¤‘(ë‚˜)</span>' : (room.status === 'AGENT' ? `<span class="badge bg-secondary">ìƒë‹´ì¤‘(${room.assignedAgent})</span>` : '')}
                        ${isWaiting ? '<span class="badge bg-warning text-dark">ì—°ê²°ëŒ€ê¸°</span>' : ''}
                        ${hasUnread && !isOpen ? '<span class="badge bg-danger">NEW</span>' : ''}
                    </div>
                </div>
                <div style="font-size: 11px; opacity: 0.6; margin-top: 2px;">${room.roomId}</div>
            `;
            div.onclick = () => selectRoom(room);
            list.appendChild(div);
        });
    }

    function updateHeader(room) {
        let statusBadge = '';
        
        if (room.status === 'BOT') statusBadge = '<span class="badge bg-info">ì±—ë´‡ìƒë‹´ì¤‘</span>';
        else if (room.status === 'WAITING') statusBadge = '<span class="badge bg-warning text-dark">ì—°ê²°ëŒ€ê¸°</span>';
        else if (room.status === 'CLOSED') statusBadge = '<span class="badge bg-danger">ìƒë‹´ì¢…ë£Œ</span>';
        else if (room.status === 'AGENT') {
            const isMyRoom = room.assignedAgent === nickname;
            statusBadge = isMyRoom ? '<span class="badge bg-primary">ìƒë‹´ì¤‘(ë‚˜)</span>' : `<span class="badge bg-secondary">ìƒë‹´ì¤‘(${room.assignedAgent})</span>`;
        }
        
        document.getElementById("chat-header").innerHTML = `
            <div class="d-flex justify-content-between align-items-center w-100">
                <div>
                    <span class="fw-bold fs-5">${room.roomName}</span> ${statusBadge}
                </div>
            </div>
        `;
    }

    function closeConsultation(roomId, status) {
        const msg = status === 'CLOSED' ? "ë°©ì„ ëª©ë¡ì—ì„œ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ìƒë‹´ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        if (!confirm(msg)) return;

        fetch(`/api/agent/rooms/${roomId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(res => {
            if (res.ok) {
                alert("ìƒë‹´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                // íƒ­ ë‹«ê¸°
                closeTab(roomId);
                loadRooms();
            } else {
                alert("ìƒë‹´ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        })
        .catch(err => console.error(err));
    }

    // íƒ­ UI ì—…ë°ì´íŠ¸
    function updateTabsUI() {
        const tabsContainer = document.getElementById("chat-tabs");
        tabsContainer.innerHTML = "";
        
        if (tabOrder.length === 0) {
            tabsContainer.innerHTML = '<div class="text-muted" style="padding: 10px;">ì—´ë¦° ìƒë‹´ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        
        tabOrder.forEach(roomId => {
            const room = openTabs[roomId];
            if (!room) return;
            
            const tabDiv = document.createElement("div");
            tabDiv.className = `chat-tab ${currentRoomId === roomId ? 'active' : ''}`;
            tabDiv.innerHTML = `
                <span>${room.roomName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                <span class="close-tab" onclick="event.stopPropagation(); closeTab('${roomId}')" title="ìƒë‹´ ì¢…ë£Œ">Ã—</span>
            `;
            tabDiv.onclick = () => switchTab(roomId);
            tabsContainer.appendChild(tabDiv);
        });
    }

    // íƒ­ ì¶”ê°€ (ìƒˆë¡œìš´ ìƒë‹´ ì—´ê¸°)
    function openTab(room) {
        if (!openTabs[room.roomId]) {
            openTabs[room.roomId] = room;
            tabOrder.push(room.roomId);
            
            // êµ¬ë… ì‹œì‘
            subscribeToRoom(room.roomId);
        }
        
        switchTab(room.roomId);
        updateTabsUI();
    }

    // íƒ­ ì „í™˜
    function switchTab(roomId) {
        if (!openTabs[roomId]) return;
        
        currentRoomId = roomId;
        const room = openTabs[roomId];
        
        unreadRooms[roomId] = false;
        updateHeader(room);
        updateInputState(room);
        
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = "";
        
        if (roomMessages[roomId]) {
            roomMessages[roomId].forEach(msg => showMessage(msg));
        }
        
        updateTabsUI();
        updateRoomListUI(roomsData);
    }

    // íƒ­ ë‹«ê¸° (ìƒë‹´ ì¢…ë£Œ)
    function closeTab(roomId) {
        if (!openTabs[roomId]) return;
        
        const room = openTabs[roomId];
        const isMyRoom = room.status === 'AGENT' && room.assignedAgent === nickname;
        
        // ë‚´ ìƒë‹´ë°©ì´ë©´ ì¢…ë£Œ í™•ì¸
        if (isMyRoom && room.status !== 'CLOSED') {
            closeConsultation(roomId, room.status);
            return;
        }
        
        // íƒ­ë§Œ ë‹«ê¸°
        delete openTabs[roomId];
        tabOrder = tabOrder.filter(id => id !== roomId);
        
        // êµ¬ë… í•´ì œ
        if (subscriptions[roomId]) {
            subscriptions[roomId].unsubscribe();
            delete subscriptions[roomId];
        }
        
        // í˜„ì¬ íƒ­ì´ì—ˆë‹¤ë©´ ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜
        if (currentRoomId === roomId) {
            if (tabOrder.length > 0) {
                switchTab(tabOrder[tabOrder.length - 1]);
            } else {
                currentRoomId = null;
                document.getElementById("chat-box").innerHTML = "";
                document.getElementById("chat-header").innerHTML = '<span class="fw-bold fs-5">ìƒë‹´ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>';
                document.getElementById("message").disabled = true;
                document.getElementById("sendBtn").disabled = true;
            }
        }
        
        updateTabsUI();
        updateRoomListUI(roomsData);
    }

    function subscribeToRoom(roomId) {
        if (!stompClient || !stompClient.connected) return;
        
        // ì´ì „ êµ¬ë… í•´ì œ
        if (subscriptions[roomId]) {
            subscriptions[roomId].unsubscribe();
        }
        
        roomMessages[roomId] = roomMessages[roomId] || [];
        
        const sub = stompClient.subscribe('/topic/room/' + roomId, function (message) {
            const msg = typeof message.body === 'string' ? JSON.parse(message.body) : message.body;
            roomMessages[roomId].push(msg);
            
            // ê³ ê° ì—°ê²° í•´ì œ ë˜ëŠ” í‡´ì¥ ì•Œë¦¼ ì²˜ë¦¬
            if (msg.type === 'CUSTOMER_DISCONNECTED' || msg.type === 'CUSTOMER_LEFT') {
                console.log('ğŸ”” ê³ ê° ì´íƒˆ ì•Œë¦¼ ìˆ˜ì‹ :', msg.type, roomId);
                
                // íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
                if (currentRoomId === roomId) {
                    showMessage(msg);
                }
                
                // ë°© ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    loadRooms();
                }, 500);
                
                // íƒ­ ë°°ì§€ì— ì•Œë¦¼ í‘œì‹œ
                if (openTabs[roomId]) {
                    const tab = document.querySelector(`.chat-tab[data-room-id="${roomId}"]`);
                    if (tab) {
                        tab.style.backgroundColor = '#ffebee'; // ì—°í•œ ë¹¨ê°„ìƒ‰ ë°°ê²½
                    }
                }
                
                return; // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬ ë¡œì§ ìƒëµ
            }
            
            if (currentRoomId === roomId) {
                showMessage(msg);
            } else {
                // ë°±ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ì•Œë¦¼
                if (msg.senderRole !== 'AGENT' && msg.type === 'TALK') {
                    unreadRooms[roomId] = true;
                    updateRoomListUI(roomsData);
                }
            }
        });
        subscriptions[roomId] = sub;
    }

    function selectRoom(room) {
        // ì´ë¯¸ ì—´ë¦° íƒ­ì´ë©´ ì „í™˜ë§Œ
        if (openTabs[room.roomId]) {
            switchTab(room.roomId);
            return;
        }

        // ì´ë¯¸ ë‹¤ë¥¸ ìƒë‹´ì›ì´ ìƒë‹´ ì¤‘ì¸ ê²½ìš° (ê°•ì œ ê°œì… ì„ íƒ ê°€ëŠ¥)
        if (room.status === 'AGENT' && room.assignedAgent && room.assignedAgent !== nickname) {
            const takeover = confirm(`${room.assignedAgent} ìƒë‹´ì›ì´ ì´ë¯¸ ìƒë‹´ ì¤‘ì…ë‹ˆë‹¤.\nì§€ê¸ˆ ì´ ìƒë‹´ì— ê°œì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!takeover) {
                return;
            }
            // ê°•ì œ ê°œì… ìš”ì²­
            fetch(`/api/agent/rooms/${room.roomId}/assign?force=true`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
            .then(res => {
                if (!res.ok) throw new Error("Force assignment failed");
                room.status = 'AGENT';
                room.assignedAgent = nickname;
                openTab(room);
            })
            .catch(err => {
                console.error(err);
                alert("ìƒë‹´ ê°œì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                loadRooms();
            });
            return;
        }

        // ìƒë‹´ì› ë°°ì •ì´ í•„ìš”í•œ ìƒíƒœ (WAITING ë˜ëŠ” BOT)ì¸ ê²½ìš° ë°°ì • API í˜¸ì¶œ
        if (room.status === 'WAITING' || room.status === 'BOT') {
            if (!confirm(room.status === 'WAITING' ? "ìƒë‹´ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì±—ë´‡ ìƒë‹´ì— ê°œì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            fetch(`/api/agent/rooms/${room.roomId}/assign`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
            .then(res => {
                if (res.status === 409) {
                    res.text().then(msg => alert(msg));
                    loadRooms();
                    return null;
                }
                if (!res.ok) throw new Error("Assignment failed");
                return res;
            })
            .then(res => {
                if (!res) return;
                // ë°°ì • ì„±ê³µ í›„ íƒ­ ì—´ê¸°
                room.status = 'AGENT';
                room.assignedAgent = nickname;
                openTab(room);
            })
            .catch(err => {
                console.error(err);
                alert("ìƒë‹´ì› ë°°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        } else {
            // ì´ë¯¸ ë°°ì •ëœ ë‚´ ìƒë‹´ë°©ì´ë©´ íƒ­ ì—´ê¸°
            openTab(room);
        }
    }

    function updateInputState(room) {
        const messageInput = document.getElementById("message");
        const sendBtn = document.getElementById("sendBtn");

        if (room.status === 'BOT') {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            messageInput.placeholder = "ì±—ë´‡ì´ ìƒë‹´ ì¤‘ì…ë‹ˆë‹¤...";
        } else if (room.status === 'CLOSED') {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            messageInput.placeholder = "ì¢…ë£Œëœ ìƒë‹´ì…ë‹ˆë‹¤.";
        } else if (room.status === 'AGENT' && room.assignedAgent && room.assignedAgent !== nickname) {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            messageInput.placeholder = `${room.assignedAgent} ìƒë‹´ì›ì´ ìƒë‹´ ì¤‘ì…ë‹ˆë‹¤...`;
        } else {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.placeholder = "ë©”ì‹œì§€ ì…ë ¥...";
        }
    }

    function sendMessage() {
        const input = document.getElementById("message");
        const content = input.value.trim();

        if(content && stompClient && currentRoomId) {
            stompClient.send("/app/agent/chat", {}, JSON.stringify({
                roomId: currentRoomId,
                sender: nickname,
                senderRole: 'AGENT',
                message: content,
                type: 'TALK'
            }));
            input.value = '';
            input.style.height = 'auto'; // ë†’ì´ ì´ˆê¸°í™”
        }
    }

    function handleKey(event) {
        const input = event.target;
        if (event.keyCode === 13) {
            if (!event.shiftKey) {
                event.preventDefault(); // ê¸°ë³¸ Enter ì¤„ë°”ê¿ˆ ë°©ì§€
                sendMessage();
            }
            // Shift + EnterëŠ” ê¸°ë³¸ ë™ì‘(ì¤„ë°”ê¿ˆ) í—ˆìš©
        }
        
        // ë†’ì´ ìë™ ì¡°ì ˆ
        setTimeout(() => {
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        }, 0);
    }

    /**
     * ì„œë²„ì—ì„œ ë°›ì€ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ "YYYY-MM-DD HH:mm:ss" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
     * @param {string|array} timestamp - ISO í˜•ì‹ ë¬¸ìì—´ ë˜ëŠ” ë°°ì—´ [year, month, day, hour, minute, second]
     */
    function formatTimestamp(timestamp) {
        if (!timestamp) {
            return getCurrentTimestamp(); // fallback to client time
        }
        
        try {
            let date;
            
            // ì„œë²„ì—ì„œ ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì˜¨ ê²½ìš° (ì˜ˆ: [2026, 1, 26, 14, 30, 45])
            if (Array.isArray(timestamp)) {
                const [year, month, day, hour, minute, second] = timestamp;
                date = new Date(year, month - 1, day, hour, minute, second);
            } 
            // ISO ë¬¸ìì—´ í˜•ì‹ì¸ ê²½ìš° (ì˜ˆ: "2026-01-26T14:30:45")
            else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                return getCurrentTimestamp(); // fallback
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        } catch (e) {
            console.error('Failed to format timestamp:', timestamp, e);
            return getCurrentTimestamp(); // fallback to client time
        }
    }

    /**
     * í´ë¼ì´ì–¸íŠ¸ í˜„ì¬ ì‹œê°„ì„ "YYYY-MM-DD HH:mm:ss" í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ (fallbackìš©)
     */
    function getCurrentTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function showMessage(msg) {
        const chatBox = document.getElementById("chat-box");
        const div = document.createElement("div");
        
        // ì„œë²„ì—ì„œ ë°›ì€ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš© (ì—†ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ ì‹œê°„ ì‚¬ìš©)
        const timestamp = formatTimestamp(msg.timestamp);

        if (msg.type === 'JOIN') {
            div.className = "system-msg";
            div.innerText = `[${timestamp}] ${msg.message}`;
        } else if (msg.type === 'LEAVE') {
            // 4. ê³ ê° ìƒë‹´ ì¢…ë£Œ í‘œì‹œ
            div.className = "system-msg";
            div.style.color = "red";
            div.innerText = `[${timestamp}] â”€â”€â”€ ${msg.message} (ìƒë‹´ ì¢…ë£Œ) â”€â”€â”€`;
        } else if (msg.type === 'CUSTOMER_DISCONNECTED') {
            // ê³ ê° ì—°ê²° í•´ì œ ì•Œë¦¼
            div.className = "system-msg";
            div.style.cssText = "color: #ff6b6b; font-weight: bold; background-color: #fff3cd; padding: 10px; border-left: 4px solid #ff6b6b;";
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">âš ï¸</span>
                    <div>
                        <div>[${timestamp}] ${msg.message}</div>
                        <div style="font-size: 0.9em; color: #856404; margin-top: 4px;">
                            ê³ ê°ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                        </div>
                    </div>
                </div>
            `;
        } else if (msg.type === 'CUSTOMER_LEFT') {
            // ê³ ê° í‡´ì¥ ì•Œë¦¼
            div.className = "system-msg";
            div.style.cssText = "color: #d32f2f; font-weight: bold; background-color: #ffebee; padding: 10px; border-left: 4px solid #d32f2f;";
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">ğŸ‘‹</span>
                    <div>
                        <div>[${timestamp}] ${msg.message}</div>
                        <div style="font-size: 0.9em; color: #c62828; margin-top: 4px;">
                            ê³ ê°ì´ ì±„íŒ…ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ìƒë‹´ì„ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”.
                        </div>
                    </div>
                </div>
            `;
        } else {
            const isMe = msg.senderRole === 'AGENT';
            div.className = `message ${isMe ? 'my' : 'other'}`;
            div.innerHTML = `
                <div class="fw-bold mb-1" style="font-size:12px">${msg.sender}</div>
                <div class="bubble">${msg.message}</div>
                <div class="timestamp">${timestamp}</div>
            `;
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>