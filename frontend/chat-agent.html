<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CHAT 상담사 콘솔</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html { height: 100vh; overflow: hidden; }
        .sidebar { height: 100%; border-right: 1px solid #ddd; padding: 20px; background: #f8f9fa; overflow-y: auto; }
        .chat-area { height: 100%; display: flex; flex-direction: column; }
        .chat-tabs { border-bottom: 1px solid #ddd; background: #fff; padding: 10px 10px 0 10px; display: flex; overflow-x: auto; }
        .chat-tab { position: relative; padding: 10px 40px 10px 15px; border: 1px solid #ddd; border-bottom: none; background: #f8f9fa; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; white-space: nowrap; transition: 0.2s; }
        .chat-tab:hover { background: #e9ecef; }
        .chat-tab.active { background: #fff; font-weight: bold; border-bottom: 2px solid #fff; margin-bottom: -1px; }
        .chat-tab .close-tab { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px; cursor: pointer; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        .chat-tab .close-tab:hover { color: #dc3545; }
        .chat-header { padding: 15px; border-bottom: 1px solid #ddd; background: #fff; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; }
        .chat-input { padding: 20px; border-top: 1px solid #ddd; background: #fff; }
        
        .room-item { cursor: pointer; padding: 10px; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; }
        .room-item:hover { background: #e9ecef; }
        .room-item.active { background: #0d6efd; color: white; }
        .room-item.waiting { border: 2px solid #ffc107; background: #fff3cd; animation: blink-waiting 1.5s infinite; }
        .room-item.needs-reply { border-left: 5px solid #dc3545; background: #f8d7da; animation: blink-reply 1s infinite; }
        
        @keyframes blink-waiting {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeeba; }
            100% { background-color: #fff3cd; }
        }

        @keyframes blink-reply {
            0% { background-color: #f8d7da; }
            50% { background-color: #f5c2c7; }
            100% { background-color: #f8d7da; }
        }
        
        .message { margin-bottom: 10px; max-width: 75%; display: flex; flex-direction: column; }
        .message.my { align-self: flex-end; align-items: flex-end; }
        .message.other { align-self: flex-start; align-items: flex-start; }
        .message .bubble { padding: 8px 15px; border-radius: 15px; font-size: 14px; white-space: pre-wrap; word-break: break-all; }
        .message.my .bubble { background: #0d6efd; color: white; border-bottom-right-radius: 2px; }
        .message.other .bubble { background: white; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .message .timestamp { font-size: 10px; color: #999; margin-top: 2px; }
        .message.my .timestamp { text-align: right; }
        .message.other .timestamp { text-align: left; }
        .system-msg { text-align: center; font-size: 12px; color: #888; margin: 10px 0; width: 100%; }
        textarea#message { resize: none; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body>

<div id="login-form" class="container mt-5" style="max-width: 400px;">
    <h3 class="text-center mb-4">상담원 로그인</h3>
    <div class="mb-3">
        <label class="form-label">아이디</label>
        <input type="text" id="loginId" class="form-control" value="agent01">
    </div>
    <div class="mb-3">
        <label class="form-label">비밀번호</label>
        <input type="password" id="loginPw" class="form-control" value="1234">
    </div>
    <button class="btn btn-primary w-100" onclick="login()">로그인</button>
</div>

<div id="admin-main" class="row g-0 h-100" style="display: none;">
    <!-- 왼쪽: 방 목록 -->
    <div class="col-md-3 sidebar">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">상담 목록</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="logout()">로그아웃</button>
        </div>
        <div class="mb-3">
            <small class="text-muted">접속 상담원:</small>
            <strong id="displayAgentName"></strong>
        </div>
        <div id="room-list">
            <!-- Room List Items -->
        </div>
    </div>

    <!-- 오른쪽: 채팅 영역 -->
    <div class="col-md-9 chat-area">
        <!-- 탭 영역 -->
        <div class="chat-tabs" id="chat-tabs">
            <!-- Tabs will be dynamically added here -->
        </div>
        
        <!-- 활성 채팅 영역 -->
        <div class="chat-header" id="chat-header">
            <span class="fw-bold fs-5">상담을 선택해주세요</span>
        </div>
        <div class="chat-box" id="chat-box">
            <!-- Messages -->
        </div>
        <div class="chat-input">
            <div class="input-group">
                <textarea id="message" class="form-control" placeholder="메시지 입력..." rows="1" disabled onkeydown="handleKey(event)"></textarea>
                <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()" disabled>전송</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentRoomId = null;
    let nickname = null;
    let authToken = null;
    let currentUserId = null; // 상담원 ID 저장
    let roomMessages = {}; // roomId -> Array of messages
    let subscriptions = {}; // roomId -> subscription object
    let unreadRooms = {}; // roomId -> boolean (true if needs reply)
    let roomsData = []; // 전역 방 데이터 보관
    let openTabs = {}; // roomId -> room object (열려있는 탭 관리)
    let tabOrder = []; // roomId 배열 (탭 순서 관리)
    let heartbeatInterval = null; // 하트비트 인터벌

    // 페이지 로드 시 로그인 상태 확인
    window.onload = function() {
        const token = sessionStorage.getItem("AGENT_TOKEN");
        if (token) {
            checkAuth(token);
        } else {
            document.getElementById("login-form").style.display = "block";
        }
    }

    function login() {
        const id = document.getElementById("loginId").value;
        const pw = document.getElementById("loginPw").value;

        // 상담원 전용 로그인 API 호출
        fetch(`/api/agent/login?id=${id}&password=${pw}`, { method: 'POST' })
            .then(res => res.json())
            .then(user => {
                sessionStorage.setItem("AGENT_TOKEN", user.token);
                sessionStorage.setItem("AGENT_NAME", user.userName);
                checkAuth(user.token);
            })
            .catch(err => alert("로그인에 실패했습니다."));
    }

    function checkAuth(token) {
        fetch('/api/agent/me', {
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => {
            if (res.ok) return res.json();
            throw new Error();
        })
        .then(user => {
            authToken = token;
            nickname = user.userName;
            currentUserId = user.userId; // 상담원 ID 저장
            document.getElementById("displayAgentName").innerText = `${nickname} (${currentUserId})`;
            document.getElementById("login-form").style.display = "none";
            document.getElementById("admin-main").style.display = "flex";
            connectWebSocket();
        })
        .catch(() => {
            sessionStorage.removeItem("AGENT_TOKEN");
            document.getElementById("login-form").style.display = "block";
            document.getElementById("admin-main").style.display = "none";
        });
    }

    function logout() {
        // 하트비트 중단
        stopHeartbeat();
        
        sessionStorage.removeItem("AGENT_TOKEN");
        window.location.reload();
    }

    function connectWebSocket() {
        // 토큰을 쿼리 파라미터로 전달
        const socket = new SockJS('/ws-chat?token=' + authToken); // /ws-chat/info?token= 엔드포인트를 자동 호출
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, function () {
            console.log("WebSocket Connected for Admin");
            
            // 1. 방 목록 실시간 푸시 구독
            stompClient.subscribe('/topic/rooms', function (message) {
                const rooms = JSON.parse(message.body);
                updateRoomListUI(rooms);
            });

            // 초기 목록 로드
            loadRooms();
            
            // 하트비트 시작 (5분마다 온라인 상태 갱신)
            startHeartbeat();
        });
    }

    /**
     * 하트비트 시작 - 온라인 상태 유지
     */
    function startHeartbeat() {
        // 즉시 한 번 실행
        sendHeartbeat();
        
        // 5분마다 하트비트 전송
        heartbeatInterval = setInterval(() => {
            sendHeartbeat();
        }, 5 * 60 * 1000); // 5분
        
        console.log('상담원 하트비트 시작 (5분 간격)');
    }

    /**
     * 하트비트 전송
     */
    function sendHeartbeat() {
        fetch('/api/agent/me', {
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(res => {
            if (res.ok) {
                console.log('하트비트 전송 성공');
            } else {
                console.warn('하트비트 전송 실패 - 재로그인 필요');
            }
        })
        .catch(err => {
            console.error('하트비트 오류:', err);
        });
    }

    /**
     * 하트비트 중단
     */
    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
            console.log('상담원 하트비트 중단');
        }
    }

    function loadRooms() {
        fetch('/api/agent/rooms')
            .then(res => res.json())
            .then(rooms => updateRoomListUI(rooms));
    }

    function updateRoomListUI(rooms) {
        roomsData = rooms;
        const list = document.getElementById("room-list");
        list.innerHTML = "";
        
        if(rooms.length === 0) {
            list.innerHTML = "<div class='text-center text-muted'>대기 중인 방이 없습니다.</div>";
            return;
        }

        rooms.forEach(room => {
            // 백그라운드 구독 관리: 열린 탭이 아닌 방은 구독 해제
            if (openTabs[room.roomId]) {
                // 열린 탭은 항상 구독 유지
                if (!subscriptions[room.roomId]) {
                    subscribeToRoom(room.roomId);
                }
            } else {
                // 열린 탭이 아니면 구독 해제
                if (subscriptions[room.roomId]) {
                    subscriptions[room.roomId].unsubscribe();
                    delete subscriptions[room.roomId];
                }
            }

            const div = document.createElement("div");
            const isBot = room.status === 'BOT';
            const isWaiting = room.status === 'WAITING';
            const isMyRoom = room.status === 'AGENT' && room.assignedAgent === nickname;
            const hasUnread = unreadRooms[room.roomId];
            const isOpen = openTabs[room.roomId] ? true : false;
            
            div.className = `room-item ${isOpen ? 'active' : ''} ${isWaiting ? 'waiting' : ''} ${hasUnread && !isOpen ? 'needs-reply' : ''}`;
            
            const displayName = room.roomName || '알 수 없는 고객';
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${displayName}</strong>
                    <div>
                        ${isOpen ? '<span class="badge bg-success">열림</span>' : ''}
                        ${isBot ? '<span class="badge bg-info">챗봇상담중</span>' : ''}
                        ${room.status === 'CLOSED' ? '<span class="badge bg-danger">상담종료</span>' : ''}
                        ${isMyRoom ? '<span class="badge bg-primary">상담중(나)</span>' : (room.status === 'AGENT' ? `<span class="badge bg-secondary">상담중(${room.assignedAgent})</span>` : '')}
                        ${isWaiting ? '<span class="badge bg-warning text-dark">연결대기</span>' : ''}
                        ${hasUnread && !isOpen ? '<span class="badge bg-danger">NEW</span>' : ''}
                    </div>
                </div>
                <div style="font-size: 11px; opacity: 0.6; margin-top: 2px;">${room.roomId}</div>
            `;
            div.onclick = () => selectRoom(room);
            list.appendChild(div);
        });
    }

    function updateHeader(room) {
        let statusBadge = '';
        
        if (room.status === 'BOT') statusBadge = '<span class="badge bg-info">챗봇상담중</span>';
        else if (room.status === 'WAITING') statusBadge = '<span class="badge bg-warning text-dark">연결대기</span>';
        else if (room.status === 'CLOSED') statusBadge = '<span class="badge bg-danger">상담종료</span>';
        else if (room.status === 'AGENT') {
            const isMyRoom = room.assignedAgent === nickname;
            statusBadge = isMyRoom ? '<span class="badge bg-primary">상담중(나)</span>' : `<span class="badge bg-secondary">상담중(${room.assignedAgent})</span>`;
        }
        
        document.getElementById("chat-header").innerHTML = `
            <div class="d-flex justify-content-between align-items-center w-100">
                <div>
                    <span class="fw-bold fs-5">${room.roomName}</span> ${statusBadge}
                </div>
            </div>
        `;
    }

    function closeConsultation(roomId, status) {
        const msg = status === 'CLOSED' ? "방을 목록에서 완전히 삭제하시겠습니까?" : "상담을 종료하시겠습니까?";
        if (!confirm(msg)) return;

        fetch(`/api/agent/rooms/${roomId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(res => {
            if (res.ok) {
                alert("상담이 종료되었습니다.");
                // 탭 닫기
                closeTab(roomId);
                loadRooms();
            } else {
                alert("상담 종료에 실패했습니다.");
            }
        })
        .catch(err => console.error(err));
    }

    // 탭 UI 업데이트
    function updateTabsUI() {
        const tabsContainer = document.getElementById("chat-tabs");
        tabsContainer.innerHTML = "";
        
        if (tabOrder.length === 0) {
            tabsContainer.innerHTML = '<div class="text-muted" style="padding: 10px;">열린 상담이 없습니다.</div>';
            return;
        }
        
        tabOrder.forEach(roomId => {
            const room = openTabs[roomId];
            if (!room) return;
            
            const tabDiv = document.createElement("div");
            tabDiv.className = `chat-tab ${currentRoomId === roomId ? 'active' : ''}`;
            tabDiv.innerHTML = `
                <span>${room.roomName || '알 수 없음'}</span>
                <span class="close-tab" onclick="event.stopPropagation(); closeTab('${roomId}')" title="상담 종료">×</span>
            `;
            tabDiv.onclick = () => switchTab(roomId);
            tabsContainer.appendChild(tabDiv);
        });
    }

    // 탭 추가 (새로운 상담 열기)
    function openTab(room) {
        if (!openTabs[room.roomId]) {
            openTabs[room.roomId] = room;
            tabOrder.push(room.roomId);
            
            // 구독 시작
            subscribeToRoom(room.roomId);
        }
        
        switchTab(room.roomId);
        updateTabsUI();
    }

    // 탭 전환
    function switchTab(roomId) {
        if (!openTabs[roomId]) return;
        
        currentRoomId = roomId;
        const room = openTabs[roomId];
        
        unreadRooms[roomId] = false;
        updateHeader(room);
        updateInputState(room);
        
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = "";
        
        if (roomMessages[roomId]) {
            roomMessages[roomId].forEach(msg => showMessage(msg));
        }
        
        updateTabsUI();
        updateRoomListUI(roomsData);
    }

    // 탭 닫기 (상담 종료)
    function closeTab(roomId) {
        if (!openTabs[roomId]) return;
        
        const room = openTabs[roomId];
        const isMyRoom = room.status === 'AGENT' && room.assignedAgent === nickname;
        
        // 내 상담방이면 종료 확인
        if (isMyRoom && room.status !== 'CLOSED') {
            closeConsultation(roomId, room.status);
            return;
        }
        
        // 탭만 닫기
        delete openTabs[roomId];
        tabOrder = tabOrder.filter(id => id !== roomId);
        
        // 구독 해제
        if (subscriptions[roomId]) {
            subscriptions[roomId].unsubscribe();
            delete subscriptions[roomId];
        }
        
        // 현재 탭이었다면 다른 탭으로 전환
        if (currentRoomId === roomId) {
            if (tabOrder.length > 0) {
                switchTab(tabOrder[tabOrder.length - 1]);
            } else {
                currentRoomId = null;
                document.getElementById("chat-box").innerHTML = "";
                document.getElementById("chat-header").innerHTML = '<span class="fw-bold fs-5">상담을 선택해주세요</span>';
                document.getElementById("message").disabled = true;
                document.getElementById("sendBtn").disabled = true;
            }
        }
        
        updateTabsUI();
        updateRoomListUI(roomsData);
    }

    function subscribeToRoom(roomId) {
        if (!stompClient || !stompClient.connected) return;
        
        // 이전 구독 해제
        if (subscriptions[roomId]) {
            subscriptions[roomId].unsubscribe();
        }
        
        roomMessages[roomId] = roomMessages[roomId] || [];
        
        const sub = stompClient.subscribe('/topic/room/' + roomId, function (message) {
            const msg = typeof message.body === 'string' ? JSON.parse(message.body) : message.body;
            roomMessages[roomId].push(msg);
            
            if (currentRoomId === roomId) {
                showMessage(msg);
            } else {
                // 백그라운드 메시지 알림
                if (msg.senderRole !== 'AGENT' && msg.type === 'TALK') {
                    unreadRooms[roomId] = true;
                    updateRoomListUI(roomsData);
                }
            }
        });
        subscriptions[roomId] = sub;
    }

    function selectRoom(room) {
        // 이미 열린 탭이면 전환만
        if (openTabs[room.roomId]) {
            switchTab(room.roomId);
            return;
        }

        // 이미 다른 상담원이 상담 중인 경우 (강제 개입 선택 가능)
        if (room.status === 'AGENT' && room.assignedAgent && room.assignedAgent !== nickname) {
            const takeover = confirm(`${room.assignedAgent} 상담원이 이미 상담 중입니다.\n지금 이 상담에 개입하시겠습니까?`);
            if (!takeover) {
                return;
            }
            // 강제 개입 요청
            fetch(`/api/agent/rooms/${room.roomId}/assign?force=true`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
            .then(res => {
                if (!res.ok) throw new Error("Force assignment failed");
                room.status = 'AGENT';
                room.assignedAgent = nickname;
                openTab(room);
            })
            .catch(err => {
                console.error(err);
                alert("상담 개입에 실패했습니다.");
                loadRooms();
            });
            return;
        }

        // 상담원 배정이 필요한 상태 (WAITING 또는 BOT)인 경우 배정 API 호출
        if (room.status === 'WAITING' || room.status === 'BOT') {
            if (!confirm(room.status === 'WAITING' ? "상담을 수락하시겠습니까?" : "챗봇 상담에 개입하시겠습니까?")) {
                return;
            }

            fetch(`/api/agent/rooms/${room.roomId}/assign`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
            .then(res => {
                if (res.status === 409) {
                    res.text().then(msg => alert(msg));
                    loadRooms();
                    return null;
                }
                if (!res.ok) throw new Error("Assignment failed");
                return res;
            })
            .then(res => {
                if (!res) return;
                // 배정 성공 후 탭 열기
                room.status = 'AGENT';
                room.assignedAgent = nickname;
                openTab(room);
            })
            .catch(err => {
                console.error(err);
                alert("상담원 배정에 실패했습니다.");
            });
        } else {
            // 이미 배정된 내 상담방이면 탭 열기
            openTab(room);
        }
    }

    function updateInputState(room) {
        const messageInput = document.getElementById("message");
        const sendBtn = document.getElementById("sendBtn");

        if (room.status === 'BOT') {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            messageInput.placeholder = "챗봇이 상담 중입니다...";
        } else if (room.status === 'CLOSED') {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            messageInput.placeholder = "종료된 상담입니다.";
        } else if (room.status === 'AGENT' && room.assignedAgent && room.assignedAgent !== nickname) {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            messageInput.placeholder = `${room.assignedAgent} 상담원이 상담 중입니다...`;
        } else {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.placeholder = "메시지 입력...";
        }
    }

    function sendMessage() {
        const input = document.getElementById("message");
        const content = input.value.trim();

        if(content && stompClient && currentRoomId) {
            stompClient.send("/app/agent/chat", {}, JSON.stringify({
                roomId: currentRoomId,
                sender: nickname,
                senderRole: 'AGENT',
                message: content,
                type: 'TALK'
            }));
            input.value = '';
            input.style.height = 'auto'; // 높이 초기화
        }
    }

    function handleKey(event) {
        const input = event.target;
        if (event.keyCode === 13) {
            if (!event.shiftKey) {
                event.preventDefault(); // 기본 Enter 줄바꿈 방지
                sendMessage();
            }
            // Shift + Enter는 기본 동작(줄바꿈) 허용
        }
        
        // 높이 자동 조절
        setTimeout(() => {
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        }, 0);
    }

    /**
     * 서버에서 받은 타임스탬프를 "YYYY-MM-DD HH:mm:ss" 형식으로 변환
     * @param {string|array} timestamp - ISO 형식 문자열 또는 배열 [year, month, day, hour, minute, second]
     */
    function formatTimestamp(timestamp) {
        if (!timestamp) {
            return getCurrentTimestamp(); // fallback to client time
        }
        
        try {
            let date;
            
            // 서버에서 배열 형식으로 온 경우 (예: [2026, 1, 26, 14, 30, 45])
            if (Array.isArray(timestamp)) {
                const [year, month, day, hour, minute, second] = timestamp;
                date = new Date(year, month - 1, day, hour, minute, second);
            } 
            // ISO 문자열 형식인 경우 (예: "2026-01-26T14:30:45")
            else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                return getCurrentTimestamp(); // fallback
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        } catch (e) {
            console.error('Failed to format timestamp:', timestamp, e);
            return getCurrentTimestamp(); // fallback to client time
        }
    }

    /**
     * 클라이언트 현재 시간을 "YYYY-MM-DD HH:mm:ss" 형식으로 반환 (fallback용)
     */
    function getCurrentTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function showMessage(msg) {
        const chatBox = document.getElementById("chat-box");
        const div = document.createElement("div");
        
        // 서버에서 받은 타임스탬프 사용 (없으면 클라이언트 시간 사용)
        const timestamp = formatTimestamp(msg.timestamp);

        if (msg.type === 'JOIN') {
            div.className = "system-msg";
            div.innerText = `[${timestamp}] ${msg.message}`;
        } else if (msg.type === 'LEAVE') {
            // 4. 고객 상담 종료 표시
            div.className = "system-msg";
            div.style.color = "red";
            div.innerText = `[${timestamp}] ─── ${msg.message} (상담 종료) ───`;
        } else {
            const isMe = msg.senderRole === 'AGENT';
            div.className = `message ${isMe ? 'my' : 'other'}`;
            div.innerHTML = `
                <div class="fw-bold mb-1" style="font-size:12px">${msg.sender}</div>
                <div class="bubble">${msg.message}</div>
                <div class="timestamp">${timestamp}</div>
            `;
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>