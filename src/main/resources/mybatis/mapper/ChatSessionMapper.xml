<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aicc.chat.mapper.ChatSessionMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="ChatSessionResultMap" type="aicc.chat.domain.persistence.ChatSession">
        <id property="id" column="id"/>
        <result property="roomId" column="room_id"/>
        <result property="roomName" column="room_name"/>
        <result property="customerId" column="customer_id"/>
        <result property="customerName" column="customer_name"/>
        <result property="assignedAgent" column="assigned_agent"/>
        <result property="status" column="status"/>
        <result property="companyId" column="company_id"/>
        <result property="startedAt" column="started_at"/>
        <result property="endedAt" column="ended_at"/>
        <result property="lastActivityAt" column="last_activity_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 상담 세션 저장 -->
    <insert id="insertChatSession" parameterType="aicc.chat.domain.persistence.ChatSession"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO chat_session (
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        ) VALUES (
            #{roomId},
            #{roomName},
            #{customerId},
            #{customerName},
            #{assignedAgent},
            #{status},
            #{companyId},
            COALESCE(#{startedAt}, NOW()),
            #{endedAt},
            COALESCE(#{lastActivityAt}, NOW()),
            COALESCE(#{createdAt}, NOW()),
            COALESCE(#{updatedAt}, NOW())
        )
    </insert>

    <!-- ID로 상담 세션 조회 -->
    <select id="selectChatSessionById" parameterType="long" resultMap="ChatSessionResultMap">
        SELECT
            id,
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        FROM chat_session
        WHERE id = #{id}
    </select>

    <!-- 채팅방 ID로 상담 세션 조회 -->
    <select id="selectChatSessionByRoomId" parameterType="string" resultMap="ChatSessionResultMap">
        SELECT
            id,
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        FROM chat_session
        WHERE room_id = #{roomId}
    </select>

    <!-- 고객 ID로 상담 세션 목록 조회 -->
    <select id="selectChatSessionsByCustomerId" parameterType="string" resultMap="ChatSessionResultMap">
        SELECT
            id,
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        FROM chat_session
        WHERE customer_id = #{customerId}
        ORDER BY started_at DESC
    </select>

    <!-- 상담원 이름으로 상담 세션 목록 조회 -->
    <select id="selectChatSessionsByAgent" parameterType="string" resultMap="ChatSessionResultMap">
        SELECT
            id,
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        FROM chat_session
        WHERE assigned_agent = #{assignedAgent}
        ORDER BY started_at DESC
    </select>

    <!-- 회사 ID와 상태로 상담 세션 목록 조회 -->
    <select id="selectChatSessionsByCompanyIdAndStatus" resultMap="ChatSessionResultMap">
        SELECT
            id,
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        FROM chat_session
        WHERE company_id = #{companyId}
          AND status = #{status}
        ORDER BY started_at DESC
    </select>

    <!-- 회사 ID와 시간 범위로 상담 세션 목록 조회 -->
    <select id="selectChatSessionsByCompanyIdAndTimeRange" resultMap="ChatSessionResultMap">
        SELECT
            id,
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        FROM chat_session
        WHERE company_id = #{companyId}
          AND started_at BETWEEN #{startTime} AND #{endTime}
        ORDER BY started_at DESC
    </select>

    <!-- 활성화된 상담 세션 목록 조회 (CLOSED 제외) -->
    <select id="selectActiveChatSessions" resultMap="ChatSessionResultMap">
        SELECT
            id,
            room_id,
            room_name,
            customer_id,
            customer_name,
            assigned_agent,
            status,
            company_id,
            started_at,
            ended_at,
            last_activity_at,
            created_at,
            updated_at
        FROM chat_session
        WHERE status != 'CLOSED'
        ORDER BY last_activity_at DESC
    </select>

    <!-- 상담 세션 정보 수정 -->
    <update id="updateChatSession" parameterType="aicc.chat.domain.persistence.ChatSession">
        UPDATE chat_session
        SET
            room_name = #{roomName},
            customer_name = #{customerName},
            assigned_agent = #{assignedAgent},
            status = #{status},
            ended_at = #{endedAt},
            last_activity_at = #{lastActivityAt},
            updated_at = NOW()
        WHERE room_id = #{roomId}
    </update>

    <!-- 상담 세션 상태 변경 -->
    <update id="updateChatSessionStatus">
        UPDATE chat_session
        SET
            status = #{status},
            updated_at = NOW()
        WHERE room_id = #{roomId}
    </update>

    <!-- 상담원 배정 -->
    <update id="updateAssignedAgent">
        UPDATE chat_session
        SET
            assigned_agent = #{assignedAgent},
            updated_at = NOW()
        WHERE room_id = #{roomId}
    </update>

    <!-- 상담 종료 시간 설정 -->
    <update id="updateEndedAt">
        UPDATE chat_session
        SET
            ended_at = #{endedAt},
            status = 'CLOSED',
            updated_at = NOW()
        WHERE room_id = #{roomId}
    </update>

    <!-- 마지막 활동 시간 갱신 -->
    <update id="updateLastActivityAt">
        UPDATE chat_session
        SET
            last_activity_at = #{lastActivityAt},
            updated_at = NOW()
        WHERE room_id = #{roomId}
    </update>

    <!-- 상담 세션 삭제 -->
    <delete id="deleteChatSessionById" parameterType="long">
        DELETE FROM chat_session
        WHERE id = #{id}
    </delete>

    <!-- 채팅방 ID로 상담 세션 삭제 -->
    <delete id="deleteChatSessionByRoomId" parameterType="string">
        DELETE FROM chat_session
        WHERE room_id = #{roomId}
    </delete>

</mapper>
